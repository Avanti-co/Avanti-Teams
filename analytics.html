<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=0.64, maximum-scale=0.64, user-scalable=no">
<script src="https://kit.fontawesome.com/419bf59dd3.js" crossorigin="anonymous"></script>
  <title>Avanti Analytics</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#3f72af">

<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("/service-worker.js")
        .then(reg => console.log("Service worker registered:", reg))
        .catch(err => console.error("Service worker error:", err));
    });
  }
</script>
  <style>
    :root{
      /* Blues pulled from your UI image */
    --bg1: #1A3C5A; /* Darker version of #2b5078 */
--bg2: #2B4C6F; /* Darker version of #396390 */
--bg3: #335A83; /* Darker version of #446e9b */

      --ink: #f5f8fc;        /* primary on-dark text */
      --muted: #94a8bd;      /* secondary text on dark */
      --header: #222223;     /* top bar */
      --green: #4dad50;      /* back button */
      --chip: rgba(255,255,255,.10);
      --chip-border: rgba(255,255,255,.18);
      --card: rgba(23,40,66,.75);
      --card-border: rgba(255,255,255,.12);
      --accent: #9fc4ff;     /* light accent for pills/badges */
      --accent-strong: #a7d3ff;
      --radius: 14px;
      --shadow: 0 10px 28px rgba(0,0,0,.30);
      --speed: .25s;
    }

    /* ===================== LAYOUT ===================== */
    *{ box-sizing: border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color: var(--ink);
      font: 15px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background: #3f72af;
padding-top: 70px;


  }
    header{
      position:sticky; top:85px; z-index:9;
      background:#fff; border-bottom:1px solid #e6ecf3;
      display:flex; align-items:center; gap:18px;
      padding:10px 18px;
    }
    header img{height:34px}
    header h1{font-size:18px; margin:0; font-weight:800; letter-spacing:.2px; color:var(--brand-ink)}
    .tabs{display:flex; margin-left:auto; gap:6px}
    .tabs button{
      border:0; background:transparent; padding:10px 12px; border-radius:10px;
      font-weight:600; color:var(--muted); cursor:pointer;
    }
    .tabs button.active{color:#fff; background:var(--brand)}
    main{padding:20px; max-width:1200px; margin-inline:auto}
    .grid{
      display:grid; gap:16px;
      grid-template-columns: repeat(12, minmax(0,1fr));
    }
    .card{
      background:var(--card);
      border:1px solid #e6ecf3; border-radius:14px;
      padding:16px;
      box-shadow:0 6px 20px -12px var(--ring);
    }
    .card h3{margin:0 0 10px 0; font-size:14px; text-transform:uppercase; letter-spacing:.12em; color:var(--muted)}
    .kpi{display:flex; align-items:baseline; gap:10px}
    .kpi .big{font-size:34px; font-weight:800}
    .kpi .sub{font-size:12px; color:var(--muted)}
    .span-3{grid-column: span 3}
    .span-4{grid-column: span 4}
    .span-6{grid-column: span 6}
    .span-8{grid-column: span 8}
    .span-9{grid-column: span 9}
    .span-12{grid-column: span 12}
    .pill{display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700}
    .pill.good{background:#e8f7f0; color:var(--good)}
    .pill.bad{background:#fdeceb; color:var(--bad)}
    .list{display:grid; gap:10px}
    .proj{
      display:flex;  gap:12px; padding:10px; border:1px solid #edf1f6; border-radius:12px;
      background:#fbfdff;
    }
    .proj .title{font-weight:700}
    .proj .meta{font-size:12px; color:var(--muted)}
    .hidden{display:none !important}
    .report{
      white-space:pre-wrap; line-height:1.55; font-size:15px;
    }
    footer{color:var(--muted); font-size:12px; text-align:center; padding:14px}
    .legend{font-size:12px; color:var(--muted)}
    .chip{display:inline-block; padding:2px 8px; background:#eff5fb; color:#436b91; font-weight:700; border-radius:999px; font-size:12px}

 .toolbar {
  position: fixed;
  left: 50%;
  bottom: 33px;
  transform: translateX(-50%);
  height: 84px;
  padding: 0 28px;
  background: rgba(22, 31, 45, 0.9);
  border-radius: 20px;
  border: 1px solid rgba(255, 255, 255, 0.12);
  display: flex;
  align-items: center;
  justify-content: space-around;
  color: #e2ebff;
  z-index: 1002;
  backdrop-filter: blur(14px) saturate(160%);
  box-shadow: 0 10px 32px rgba(0, 0, 0, 0.35);
  transition: all 0.3s ease;
width: 98%;
}

.toolbar-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 6px;
  min-width: 64px;
  cursor: pointer;
  transition: transform 0.25s, color 0.25s;
}

.toolbar-item i {
  font-size: 26px;
  padding: 12px;
  border-radius: 14px;
  transition: background 0.25s, transform 0.25s;
}

.toolbar-item span {
  font-size: 13px;
  font-weight: 500;
  color: rgba(255, 255, 255, 0.85);
  transition: color 0.25s;
margin-top: -10px;
}

.toolbar-item:hover i {
  background: rgba(255, 255, 255, 0.14);
  transform: translateY(-3px);
}

.toolbar-item:hover span {
  color: #ffffff;
}

:root {
  --bg1: #1A3C5A;
  --bg2: #2B4C6F;
  --bg3: #335A83;

  --ink: #f5f8fc;
  --muted: #94a8bd;
  --green: #4dad50;
  --card: rgba(23,40,66,0.75);
  --card-border: rgba(255,255,255,0.12);
  --radius: 14px;
  --shadow: 0 10px 28px rgba(0,0,0,.30);
}

/* Background */
body {
  margin: 0;
  color: var(--ink);
  font-family: 'Inter', system-ui, sans-serif;
  background: linear-gradient(180deg, var(--bg1), var(--bg2) 45%, var(--bg3));
  padding-top: 85px;
}

/* Top bar */
header {
  position: sticky;
  top: 85px;
  z-index: 9;
  background: rgba(22, 31, 45, 0.85);
  border-bottom: 1px solid var(--card-border);
  backdrop-filter: blur(14px);
  display: flex;
  align-items: center;
  gap: 18px;
  padding: 10px 18px;
}

header h1 {
  font-size: 18px;
  margin: 0;
  font-weight: 800;
  color: var(--ink);
}

/* Tabs */
.tabs button {
  border: 0;
  background: transparent;
  padding: 10px 12px;
  border-radius: 10px;
  font-weight: 600;
  color: var(--muted);
  cursor: pointer;
  transition: background 0.25s, color 0.25s;
}
.tabs button.active {
  color: #fff;
  background: rgba(255, 255, 255, 0.1);
}

/* Cards */
.card {
  background: var(--card);
  border: 1px solid var(--card-border);
  border-radius: var(--radius);
  padding: 16px;
  box-shadow: var(--shadow);
  backdrop-filter: blur(16px);
}
.card h3 {
  margin: 0 0 10px 0;
  font-size: 14px;
  text-transform: uppercase;
  letter-spacing: .12em;
  color: var(--muted);
}

/* KPI */
.kpi .big {
  font-size: 34px;
  font-weight: 800;
}
.kpi .sub {
  font-size: 12px;
  color: var(--muted);
}

/* Proj List Items */
.proj {
  display: flex;
  flex-direction: column;
  gap: 6px;
  padding: 12px;
  border-radius: 12px;
  background: rgba(255, 255, 255, 0.06);
  border: 1px solid var(--card-border);
}
.proj .title { font-weight: 700; }
.proj .meta { font-size: 12px; color: var(--muted); }

/* Pills */
.pill {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 700;
}
.pill.good { background: rgba(76, 175, 80, 0.2); color: #4caf50; }
.pill.bad { background: rgba(244, 67, 54, 0.2); color: #f44336; }

/* Chip */
.chip {
  display: inline-block;
  padding: 2px 8px;
  background: rgba(255, 255, 255, 0.08);
  border: 1px solid rgba(255, 255, 255, 0.12);
  border-radius: 999px;
  font-size: 12px;
  font-weight: 700;
  color: var(--accent-strong);
}

/* Footer */
footer {
  color: var(--muted);
  font-size: 12px;
  text-align: center;
  padding: 14px;
  margin-bottom: 100px;
}
/* Container for the daily calendar */
.calendar {
  
  gap: 16px;
  padding: 15px;
  background-color: #1e1f26;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
  font-family: 'Inter', sans-serif;
}

/* Hour column */
.calendar .hour {
  font-size: 13px;
  color: #9ca3af;
  text-align: right;
  padding-right: 12px;
  margin-top: 4px;
  user-select: none;
}

/* Vertical slot line for timeline */
.calendar .slot {
  border-left: 2px solid #3b82f6;
  padding-left: 14px;
  margin-bottom: 24px;
  position: relative;
}

/* Optional: subtle horizontal grid lines */
.calendar .slot::before {
  content: "";
  position: absolute;
  left: -2px;
  top: 50%;
  width: 100%;
  height: 1px;
  background: rgba(255, 255, 255, 0.05);
  z-index: 0;
}

/* Individual task card */
.calendar .task {
  background: #272b35;
  border-left: 4px solid #3b82f6;
  padding: 10px 12px;
  border-radius: 8px;
  margin: 6px 0;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
  transition: transform 0.2s ease, background 0.2s ease;
  cursor: pointer;
  position: relative;
  z-index: 1;
}

/* Hover effect for tasks */
.calendar .task:hover {
  background: #32373f;
  transform: translateX(4px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

/* Task title */
.calendar .task .title {
  font-weight: 600;
  color: #fff;
  font-size: 14px;
  margin-bottom: 4px;
}

/* Task meta info (time, labels) */
.calendar .task .meta {
  font-size: 12px;
  color: #9ca3af;
  line-height: 1.3;
}

/* Scrollable timeline if many slots */
.calendar {
  max-height: 700px;
  overflow-y: auto;
}

/* Custom scrollbar for a sleek look */
.calendar::-webkit-scrollbar {
  width: 6px;
}

.calendar::-webkit-scrollbar-thumb {
  background-color: #3b82f6;
  border-radius: 3px;
}

.calendar::-webkit-scrollbar-track {
  background: #1e1f26;
}

/* Responsive tweaks */
@media (max-width: 768px) {
  .calendar {
    grid-template-columns: 60px 1fr;
    gap: 12px;
  }
  .calendar .hour {
    font-size: 12px;
    padding-right: 8px;
  }
  .calendar .task {
    padding: 8px 10px;
    font-size: 13px;
  }
}


/* Container for the entire week */
.week-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 16px;
  margin-top: 20px;
  padding: 15px;
  background-color: #1e1f26; /* Slightly darker for elegance */
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
  font-family: 'Inter', sans-serif;
}

/* Each day column */
.week-day {
  background: #272b35;
  border: 1px solid #3b4048;
  border-radius: 10px;
  padding: 16px;
  display: flex;
  flex-direction: column;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.week-day:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
}

/* Day header */
.week-day h4 {
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 12px;
  color: #60a5fa;
  text-align: center;
  letter-spacing: 0.5px;
  border-bottom: 1px solid #3b4048;
  padding-bottom: 6px;
}

/* Task container inside a day */
.week-task {
  background: #32373f;
  border-left: 4px solid #60a5fa;
  border-radius: 6px;
  padding: 10px 12px;
  margin-bottom: 10px;
  font-size: 13px;
  color: #e0e0e0;
  cursor: pointer;
  transition: background 0.2s ease, transform 0.2s ease;
}

.week-task:hover {
  background: #3c4149;
  transform: translateX(4px);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

/* Optional: small time label for each task */
.week-task span.time {
  display: block;
  font-size: 11px;
  color: #a0aec0;
  margin-bottom: 4px;
}

/* Scrollable days if tasks overflow */
.week-day {
  max-height: 500px; /* adjust as needed */
  overflow-y: auto;
}

/* Scrollbar styling (modern look) */
.week-day::-webkit-scrollbar {
  width: 6px;
}

.week-day::-webkit-scrollbar-thumb {
  background-color: #60a5fa;
  border-radius: 3px;
}

.week-day::-webkit-scrollbar-track {
  background: #272b35;
}

/* Responsive tweak for smaller screens */
@media (max-width: 1024px) {
  .week-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 600px) {
  .week-grid {
    grid-template-columns: 1fr;
  }
}

 .topbar {
  height: 72px;
  width: 100%;
  position: fixed;
  top: 0;
  left: 0;
  z-index: 1000;

  /* Theme Styling */
  background-color: #3f72af;
  border-bottom: 1px solid rgba(255, 255, 255, 0.15);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);

  /* Layout */
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 24px;
}

/* ===== LEFT SECTION (Logo / Brand) ===== */
.topbar .brand {
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 20px;
  font-weight: 700;
  color: #fff;
  letter-spacing: 0.5px;
}
.topbar .brand img {
  height: 55px;
  width: 45px;
  border-radius: 8px;
  object-fit: cover;
}


    .brand{
      display:flex; align-items:center; gap:12px; font-weight:800; letter-spacing:.3px;
    }
    .brand .logo{
      width:42px; height:42px; border-radius:15px; overflow:hidden; flex:none;
    }
    .brand h1{
      margin:0; font-size:18px; font-weight:800;
    }
    .brand h1 span{ color:#ffc107; font-weight:800; }

    .back-btn{
      background: var(--green);
      color:#fff; border:0; padding:9px 14px; border-radius:10px;
      cursor:pointer; font-weight:700;
      display:inline-flex; gap:8px; align-items:center;
      box-shadow: 0 6px 18px rgba(77,173,80,.35);
      transition: transform var(--speed);
    }
    .back-btn:hover{ transform: translateY(-1px); }
  </style>
</head>
<body style="padding-bottom: 500px;">
  <div class="topbar">
    <div class="brand">
      <img class="logo" src="https://ik.imagekit.io/3mtmeexff/IMG_8590.jpeg?updatedAt=1755948361293" alt="">
      <div>
        <h1>Avanti <span>Teams</span></h1>
        <div style="font-size:12px; color:#b6c8dc; font-weight:700">Design • Develop • Evolve</div>
      </div>

    </div>

  <div class="tabs">
      <button class="active" data-tab="analytics">Analytics</button>
      <button data-tab="statistics">Statistics</button>
      <button data-tab="reports">Reports</button>
    </div>
  
  </div>



  <main style="margin-bottom: 70px; margin-top: 20px;">
    <!-- ANALYTICS -->
    <section id="analytics" class="tab">
      <div class="grid">
        <!-- KPIs -->
        <div class="card span-3"><h3>Total Projects</h3><div class="kpi"><div class="big" id="kpi-total">–</div></div></div>
        <div class="card span-3"><h3 >Individual Files</h3><div class="kpi"><div class="big" id="kpi-ind">–</div></div></div>
        <div class="card span-3"><h3>Folder Projects</h3><div class="kpi"><div class="big" id="kpi-fold">–</div></div></div>
        <div class="card span-3"><h3>Total Folders</h3><div class="kpi"><div class="big" id="kpi-folders">–</div></div></div>

        <!-- Status distribution -->
        <div class="card span-8">
          <h3>Status distribution</h3>
          <canvas id="statusChart" height="140"></canvas>
          <div class="legend">Fact Finding • Design • Development • Testing & Debugging • Implementation • Complete</div>
        </div>

        <!-- Payments -->
        <div class="card span-4">
          <h3>Payment status</h3>
          <canvas id="paymentPie" height="140"></canvas>
        </div>

        <!-- Pending payment cards -->
        <div class="card span-12">
          <h3>Projects with Pending Payment</h3>
          <div id="pendingList" class="list"></div>
        </div>

        <!-- Top categories -->
        <div class="card span-12">
          <h3>Top 5 categories</h3>
          <canvas id="topCats" height="160"></canvas>
        </div>
<br>
        <!-- Top budgets -->
        <div class="card span-12">
          <h3>Top 10 high-paying projects (This Year / This Month)</h3>
          <canvas id="topBudget" height="160"></canvas>
        </div>
      </div>
    </section>

    <!-- STATISTICS -->
    <section id="statistics" class="tab hidden">
      <div class="grid">
        <div class="card span-3"><h3>Companies</h3><div class="kpi"><div class="big" id="kpi-company">–</div></div></div>
        <div class="card span-3"><h3>Individuals</h3><div class="kpi"><div class="big" id="kpi-individual">–</div></div></div>
        <div class="card span-3"><h3>This week</h3><div class="kpi"><div class="big" id="kpi-week">–</div><div class="sub">starts in last 7 days</div></div></div>
        <div class="card span-3"><h3>Last 2 weeks</h3><div class="kpi"><div class="big" id="kpi-2weeks">–</div></div></div>

        <div class="card span-3"><h3>This month</h3><div class="kpi"><div class="big" id="kpi-month">–</div></div></div>
        <div class="card span-3"><h3>Last 2 months</h3><div class="kpi"><div class="big" id="kpi-2months">–</div></div></div>
        <div class="card span-3"><h3>Avg Budget</h3><div class="kpi"><div class="big" id="kpi-avg-budget">–</div><div class="sub" id="budget-currency"></div></div></div>
        <div class="card span-3"><h3>Prepaid</h3><div class="kpi"><div class="big" id="kpi-prepaid">–</div><div class="sub">true/false flag</div></div></div>

        <div class="card span-12">
          <h3>Status → Count</h3>
          <div id="statusTable" class="list"></div>
        </div>
      </div>
    </section>

    <!-- REPORTS -->
    <section id="reports" class="tab hidden">
      <div class="grid">
        <div class="card span-12">
          <h3>Completion Ratio</h3>
          <canvas id="completeRatio" height="160"></canvas>
        </div>
        <div class="card span-12">
          <h3>Priority by Size • Payment • Status</h3>
          <canvas id="priorityBar" height="160"></canvas>
          <div class="legend">Higher score = higher urgency (size + payment + status stage weighting)</div>
        </div>
        <div class="card span-12">
          <h3>Schedule of the Week</h3>
          <div id="schedule" class="list"></div>
        </div>
        <div class="card span-12">
          <h3>Week Extensions & Reasons</h3>
          <div id="extensions" class="list"></div>
        </div>
        <div class="card span-12">
          <h3>Executive Report</h3>
          <div id="execReport" class="report"></div>
        </div>

      </div>
    </section>
  </main>
   <div class="toolbar">
   <div class="toolbar-item" id="Home">
    <i class="fas fa-home" onclick="window.location='index.html'"></i><span>Home</span></div>

  <div class="toolbar-item">
    <i class="fas fa-envelope" onclick="window.location='select-template.html'"></i> <span>Newsletters</span></div>

  
 <div class="toolbar-item" style="color: #ffc107;">
    <i class="fas fa-chart-line" onclick="window.location='analytics.html'"></i> <span style="color: #ffc107;">Analytics</span></div>

 <div class="toolbar-item">
    <i class="fas fa-database" onclick="window.location='client-list.html'"></i><span>Database</span> </div>
  </div>

  <footer>© <span id="year"></span> </footer>

<script>
/* ----------------------------- CONFIG ----------------------------- */

// 1) Put your Firebase config here
const firebaseConfig = {
  apiKey: "AIzaSyAw7L6TJtF1W0PwfStEJUC4CebUyMdQU9w",
  authDomain: "users-66be4.firebaseapp.com",
  databaseURL: "https://users-66be4-default-rtdb.firebaseio.com",
  projectId: "users-66be4",
  storageBucket: "users-66be4.appspot.com",
  messagingSenderId: "776585122050",
  appId: "1:776585122050:web:3f452a1f16dc36ee1ef21b"
};

// 2) Data roots (change only if your paths differ)
const INDEPENDENT_ROOT = "project_files";     // independent projects
const FOLDERS_ROOT     = "folders";           // folders/{folderId}/projects/{projectId}

/* ---------------------------- APP STATE --------------------------- */

const StatusOrder = [
  "Fact Finding", "Design", "Development", "Testing & Debugging", "Implementation", "Complete"
];

const SizeWeight = { Small: 1, Medium: 2, Large: 3 };
const PaymentWeight = { Pending: 2, "Complete": 0, Completed: 0 }; // handle 'Complete' or 'Completed'
const StatusWeight = {
  "Fact Finding": 3, "Design": 3, "Development": 2, "Testing & Debugging": 2, "Implementation": 1, "Complete": 0
};

let charts = {};
let MODEL = {
  folders: [],               // {id, meta, projects:[...]}
  independent: [],           // [{...project}]
  unified: []                // [{...project, source:'independent'|'folder', uid:'id' or 'folderId/projectId'}]
};

/* ---------------------------- UTILITIES --------------------------- */

const toNumber = (v) => {
  if (v == null) return 0;
  if (typeof v === "number") return v;
  const s = String(v).replace(/[^0-9.\-]/g,'').trim();
  const n = parseFloat(s); return Number.isFinite(n) ? n : 0;
};

function parseStartDate(p){ // tries StartDate (YYYY-MM-DD), then createdAt (ms), then numeric id
  if (p.StartDate) {
    const d = new Date(p.StartDate);
    if(!isNaN(d)) return d;
  }
  if (p.createdAt) {
    const d = new Date(Number(p.createdAt));
    if(!isNaN(d)) return d;
  }
  if (p.id && /^\d{12,}$/.test(String(p.id))) {
    const d = new Date(Number(p.id));
    if(!isNaN(d)) return d;
  }
  return null;
}

function parseDurationDays(p){ // accepts "2 weeks", "10 days", number etc.
  const raw = p.Duration ?? p.duration ?? "";
  if (typeof raw === "number") return raw;
  const s = String(raw).trim().toLowerCase();
  const m = s.match(/(\d+(?:\.\d+)?)\s*(day|days|week|weeks|month|months)?/i);
  if(!m) return 0;
  const n = parseFloat(m[1]);
  const unit = (m[2]||"days").toLowerCase();
  if(unit.startsWith("week")) return Math.round(n*7);
  if(unit.startsWith("month")) return Math.round(n*30);
  return Math.round(n);
}

function sumDayExtensions(p){
  // expect p.Commits.{commitId}.extensions = [{amount,reason,timestamp}]
  let total = 0;
  const commits = p.Commits || p.commits || {};
  Object.values(commits).forEach(c=>{
    const ext = (c.extensions || c.Extensions || {});
    // ext can be array or keyed object starting at 0
    if (Array.isArray(ext)) {
      ext.forEach(e=> total += toNumber(e?.amount));
    } else {
      Object.values(ext).forEach(e=> total += toNumber(e?.amount));
    }
  });
  return total;
}

function getDueDate(p){
  const start = parseStartDate(p);
  if(!start) return null;
  const durDays = parseDurationDays(p);
  const extra = sumDayExtensions(p);
  const due = new Date(start);
  due.setDate(due.getDate() + durDays + extra);
  return due;
}

function fmtDate(d){
  if(!d) return "—";
  return d.toISOString().slice(0,10);
}

function monthKey(d){
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
}

/* ---------------------------- DATA LOAD --------------------------- */

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

async function once(refPath){
  const snap = await db.ref(refPath).get();
  return snap.exists() ? snap.val() : null;
}

async function loadData(){
  // 1) Independent
  const rawInd = await once(INDEPENDENT_ROOT);
  const independent = [];
  if (rawInd && typeof rawInd === "object") {
    Object.entries(rawInd).forEach(([k,v])=>{
      // some datasets key by projectId (timestamp), others by name
      if (v && typeof v === "object") {
        independent.push({...v, id: v.id || k, _id: k, source:"independent"});
      }
    });
  }

  // 2) Folders with nested projects
  const rawFolders = await once(FOLDERS_ROOT);
  const folders = [];
  if (rawFolders && typeof rawFolders === "object") {
    Object.entries(rawFolders).forEach(([folderId,meta])=>{
      const projectsNode = (meta && meta.projects) || {};
      const projects = [];
      Object.entries(projectsNode).forEach(([pid,pval])=>{
        if (pval && typeof pval === "object") {
          projects.push({...pval, id: pval.id || pid, _id: pid, folderId, source:"folder"});
        }
      });
      const {projects:_, ...folderMeta} = meta || {};
      folders.push({id:folderId, meta:folderMeta, projects});
    });
  }

  // 3) Unified
  const folderProjects = folders.flatMap(f => f.projects.map(p => ({...p, uid:`${f.id}/${p._id}`})));
  const independentProjects = independent.map(p => ({...p, uid:String(p._id)}));
  const unified = [...independentProjects, ...folderProjects];

  MODEL = { folders, independent, unified };
  renderAll();
}

/* ------------------------------ RENDER ---------------------------- */

function setKPI(id, val){ document.getElementById(id).textContent = val; }

function renderKPIs(){
  const total = MODEL.unified.length;
  const ind   = MODEL.independent.length;
  const foldP = MODEL.folders.reduce((a,f)=> a + f.projects.length, 0);
  const folds = MODEL.folders.length;
  setKPI("kpi-total", total);
  setKPI("kpi-ind", ind);
  setKPI("kpi-fold", foldP);
  setKPI("kpi-folders", folds);
}

function computeStatusCounts(){
  const counts = {};
  StatusOrder.forEach(s=> counts[s]=0);
  MODEL.unified.forEach(p=>{
    const s = (p.Status || p.status || "").trim();
    const norm = s.toLowerCase().includes("test") ? "Testing & Debugging"
               : s.toLowerCase().includes("fact") ? "Fact Finding"
               : s.toLowerCase().includes("design") ? "Design"
               : s.toLowerCase().includes("develop") ? "Development"
               : s.toLowerCase().includes("imple") ? "Implementation"
               : s.toLowerCase().includes("compl") ? "Complete"
               : s || "Fact Finding";
    counts[norm] = (counts[norm] || 0) + 1;
  });
  return counts;
}

function renderStatusChart(){
  const counts = computeStatusCounts();
  const data = StatusOrder.map(s=> counts[s]||0);
  charts.status?.destroy();
  charts.status = new Chart(document.getElementById("statusChart"),{
    type:"bar",
    data:{labels:StatusOrder, datasets:[{label:"Projects", data}]},
    options:{responsive:true, plugins:{legend:{display:false}}}
  });
  // Statistics tab table
  const table = document.getElementById("statusTable");
  table.innerHTML = "";
  StatusOrder.forEach(s=>{
    const li = document.createElement("div");
    li.className = "proj";
    li.innerHTML = `<div class="title">${s}</div><div class="meta"> | ${counts[s]||0} projects</div>`;
    table.appendChild(li);
  });
}

function renderPayments(){
  let pending=0, complete=0;
  const pendList = document.getElementById("pendingList");
  pendList.innerHTML = "";
  MODEL.unified.forEach(p=>{
    const pay = (p.PaymentStatus || p.paymentStatus || "").toLowerCase();
    if (pay.startsWith("pend")) pending++;
    else complete++;
    if (pay.startsWith("pend")) {
      const li = document.createElement("div");
      const label = p.source==='folder' ? `${p.folderId}/${p.ProjectName}` : `${p.ProjectName||p.id||p._id}`;
      li.className="proj";
      li.innerHTML = `
        <div class="title">${label}</div>

        <div class="meta">Budget: ${p.Budget ?? '—'} • Client: ${p.ClientName || p.CompanyName}</div>
        <span class="pill bad">PENDING</span>`;
      pendList.appendChild(li);
    }
  });
  charts.pay?.destroy();
  charts.pay = new Chart(document.getElementById("paymentPie"),{
    type:"doughnut",
    data:{labels:["Pending","Complete"], datasets:[{data:[pending,complete]}]},
    options:{plugins:{legend:{position:"bottom"}}}
  });
}

function renderTopCategories(){
  const freq = {};
  MODEL.unified.forEach(p=>{
    const c = (p.Category || p.category || "Unspecified").trim();
    if(!c) return;
    freq[c] = (freq[c]||0) + 1;
  });
  const top = Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,5);
  charts.cats?.destroy();
  charts.cats = new Chart(document.getElementById("topCats"),{
    type:"bar",
    data:{labels:top.map(x=>x[0]), datasets:[{label:"Count", data:top.map(x=>x[1])}]},
    options:{plugins:{legend:{display:false}}}
  });
}

function renderTopBudget(){
  // group by year & month based on StartDate (fallback: createdAt)
  const now = new Date();
  const thisYear = now.getFullYear();
  const thisMonthKey = monthKey(now);

  const annotate = MODEL.unified.map(p=>{
    const start = parseStartDate(p) || new Date(0);
    return { p, budget: toNumber(p.Budget), month: monthKey(start), year: start.getFullYear() };
  });

  const yearTop = annotate.filter(x=>x.year===thisYear)
    .sort((a,b)=>b.budget-a.budget).slice(0,10);

  const monthTop = annotate.filter(x=>x.month===thisMonthKey)
    .sort((a,b)=>b.budget-a.budget).slice(0,10);

  const labels = Array.from(new Set([...yearTop,...monthTop].map(x=>x.p.source==='folder' ? `${x.p.folderId}/${x.p.ProjectName}` : (x.p.ProjectName||x.p.id||x.p._id))));
  const dataYear = labels.map(l=>{
    const x = yearTop.find(t => (t.p.source==='folder'? `${t.p.folderId}/${t.p.ProjectName}` : (t.p.ProjectName||t.p.id||t.p._id))===l);
    return x ? x.budget : 0;
  });
  const dataMonth = labels.map(l=>{
    const x = monthTop.find(t => (t.p.source==='folder'? `${t.p.folderId}/${t.p.ProjectName}` : (t.p.ProjectName||t.p.id||t.p._id))===l);
    return x ? x.budget : 0;
  });

  charts.budget?.destroy();
  charts.budget = new Chart(document.getElementById("topBudget"),{
    type:"bar",
    data:{labels, datasets:[
      {label:`Top ${thisYear}`, data:dataYear},
      {label:"Top this month", data:dataMonth}
    ]},
    options:{responsive:true}
  });
}

function renderStatistics(){
  const total = MODEL.unified.length;
  const company = MODEL.unified.filter(p => (p.For||p.for||"").toLowerCase().startsWith("comp")).length;
  const individual = MODEL.unified.filter(p => (p.For||p.for||"").toLowerCase().startsWith("indiv")).length;

  const now = new Date();
  const weekAgo = new Date(now); weekAgo.setDate(now.getDate()-7);
  const twoWeeks = new Date(now); twoWeeks.setDate(now.getDate()-14);
  const monthAgo = new Date(now); monthAgo.setMonth(now.getMonth()-1);
  const twoMonths = new Date(now); twoMonths.setMonth(now.getMonth()-2);

  const byStart = (d)=> (parseStartDate(d) || new Date(0));
  const inRange = (p,from)=> byStart(p) >= from;

  const thisWeek = MODEL.unified.filter(p=> inRange(p,weekAgo)).length;
  const last2Weeks = MODEL.unified.filter(p=> inRange(p,twoWeeks)).length;
  const thisMonth = MODEL.unified.filter(p=> inRange(p,monthAgo)).length;
  const last2Months = MODEL.unified.filter(p=> inRange(p,twoMonths)).length;

  const budgets = MODEL.unified.map(p=> toNumber(p.Budget)).filter(n=>n>0);
  const avgBudget = budgets.length ? Math.round(budgets.reduce((a,b)=>a+b,0)/budgets.length) : 0;
  const prepaidCount = MODEL.unified.filter(p=> p.Prepaid===true).length;

  setKPI("kpi-company", company);
  setKPI("kpi-individual", individual);
  setKPI("kpi-week", thisWeek);
  setKPI("kpi-2weeks", last2Weeks);
  setKPI("kpi-month", thisMonth);
  setKPI("kpi-2months", last2Months);
  setKPI("kpi-avg-budget", avgBudget);
  setKPI("kpi-prepaid", prepaidCount);
}

function renderCompletionRatio(){
  const complete = MODEL.unified.filter(p => (p.Status||"").toLowerCase().startsWith("compl")).length;
  const incomplete = MODEL.unified.length - complete;
  charts.ratio?.destroy();
  charts.ratio = new Chart(document.getElementById("completeRatio"),{
    type:"pie",
    data:{labels:["Complete","Incomplete"], datasets:[{data:[complete,incomplete]}]},
    options:{plugins:{legend:{position:"bottom"}}}
  });
}

function projectPriorityScore(p){
  const size = SizeWeight[(p.Size||"").trim()] ?? 2;
  const pay  = PaymentWeight[(p.PaymentStatus||"").trim()] ?? 0;
  const stat = StatusWeight[(p.Status||"").trim()] ?? 1;
  return size + pay + stat;
}

function renderPriority(){
  const top = MODEL.unified
    .map(p=>({p,score:projectPriorityScore(p)}))
    .sort((a,b)=>b.score-a.score).slice(0,12);

  charts.priority?.destroy();
  charts.priority = new Chart(document.getElementById("priorityBar"),{
    type:"bar",
    data:{labels:top.map(x=> x.p.source==='folder' ? `${x.p.folderId}/${x.p.ProjectName}` : (x.p.ProjectName||x.p.id||x.p._id)),
          datasets:[{label:"Priority score", data:top.map(x=>x.score)}]},
    options:{plugins:{legend:{display:false}}}
  });
}

function renderScheduleOfWeek(){
  const box = document.getElementById("schedule");
  box.innerHTML = "";
  const now = new Date();
  const inThisWeek = (p)=>{
    const s = parseStartDate(p);
    if(!s) return false;
    const weekStart = new Date(now); weekStart.setDate(now.getDate()-7);
    return s >= weekStart;
  };

  const items = MODEL.unified
    .map(p=>{
      const due = getDueDate(p);
      const daysLeft = due ? Math.ceil((due - now)/(1000*60*60*24)) : null;
      const risk = (daysLeft!==null && daysLeft<0) ? "Overdue"
                 : (daysLeft!==null && daysLeft<=2) ? "At Risk" : "On Track";
      const label = p.source==='folder' ? `${p.folderId}/${p.ProjectName}` : (p.ProjectName||p.id||p._id);
      return {p,label,due,daysLeft,risk,score:projectPriorityScore(p)};
    })
    .sort((a,b)=> b.score-a.score || (a.daysLeft??9999)-(b.daysLeft??9999));

  items.slice(0,15).forEach(x=>{
    const item = document.createElement("div");
    item.className="proj";
    const riskPill = `<span class="pill ${x.risk==='Overdue'?'bad':(x.risk==='At Risk'?'bad':'good')}">${x.risk}</span>`;
    item.innerHTML = `
      <div class="title">${x.label}</div>
      <div class="meta">Status: ${x.p.Status||'—'} • Size: ${x.p.Size||'—'} • Due: ${fmtDate(x.due)} • ${x.daysLeft!==null? `${x.daysLeft} days left` : 'no due date'}</div>
      ${riskPill}
      <span class="chip">Priority ${x.score}</span>`;
    box.appendChild(item);
  });
}

function renderExtensionsReport(){
  const box = document.getElementById("extensions");
  box.innerHTML = "";
  const rows = MODEL.unified.map(p=>{
    const totalExt = sumDayExtensions(p);
    if (totalExt<=0) return null;
    const label = p.source==='folder' ? `${p.folderId}/${p.ProjectName}` : (p.ProjectName||p.id||p._id);
    const reasons = [];
    const commits = p.Commits || {};
    Object.values(commits).forEach(c=>{
      const ext = c.extensions || {};
      const arr = Array.isArray(ext) ? ext : Object.values(ext);
      arr.forEach(e=>{
        if (e && e.reason) reasons.push(`• ${e.reason} (${e.amount}d on ${e.timestamp||'n/a'})`);
      });
    });
    return {label,totalExt,reasons};
  }).filter(Boolean).sort((a,b)=>b.totalExt-a.totalExt);

  if (!rows.length){
    const item = document.createElement("div");
    item.className="proj";
    item.textContent = "No day extensions recorded this week.";
    box.appendChild(item);
    return;
  }
  rows.forEach(r=>{
    const item = document.createElement("div");
    item.className="proj";
    item.innerHTML = `<div class="title">${r.label}</div>
      <div class="meta">Total extensions: ${r.totalExt} day(s)</div>
      <div style="font-size:12px;color:var(--muted)">${r.reasons.join("<br>")}</div>`;
    box.appendChild(item);
  });
}

function renderExecutiveReport(){
  const total = MODEL.unified.length;
  const completed = MODEL.unified.filter(p=>(p.Status||"").toLowerCase().startsWith("compl")).length;
  const pendingPay = MODEL.unified.filter(p=>(p.PaymentStatus||"").toLowerCase().startsWith("pend")).length;
  const company = MODEL.unified.filter(p=>(p.For||"").toLowerCase().startsWith("comp")).length;
  const indiv = MODEL.unified.filter(p=>(p.For||"").toLowerCase().startsWith("indiv")).length;

  const topCat = (() => {
    const f={}; MODEL.unified.forEach(p=>{ const c=p.Category||"Unspecified"; f[c]=(f[c]||0)+1; });
    return Object.entries(f).sort((a,b)=>b[1]-a[1]).slice(0,3).map(([k,v])=>`${k} (${v})`).join(", ");
  })();

  const late = MODEL.unified
    .map(p=>({p, due:getDueDate(p)}))
    .filter(x=>x.due && x.due < new Date());

  const para = `
This week at Avanti, we’re tracking ${total} active projects: ${completed} completed, ${total-completed} in progress.
Payment risk remains with ${pendingPay} project(s) pending payment.
Client mix is ${company} company vs ${indiv} individual initiatives.

Category momentum: ${topCat || 'No dominant categories yet'}.

Schedule outlook: ${late.length ? `${late.length} project(s) appear overdue based on start date, duration and recorded day-extensions.` : 'all projects appear on or ahead of schedule.'}
Priority is being driven primarily by size, payment status and delivery stage; the priority board highlights the top items requiring attention.

Recommendations:
• Focus on clearing pending payments and closing items in Testing & Debugging and Implementation stages.
• Review overdue items for potential scope adjustments or additional day-extensions where justified.
• Maintain momentum in top categories to maximize delivery efficiency and team familiarity.
  `.trim();

  document.getElementById("execReport").textContent = para;
}


/* ----------------------------- ORCHESTRA -------------------------- */

function renderAll(){
  renderKPIs();
  renderStatusChart();
  renderPayments();
  renderTopCategories();
  renderTopBudget();
  renderStatistics();
  renderCompletionRatio();
  renderPriority();
  renderScheduleOfWeek();
  renderExtensionsReport();
  renderExecutiveReport();

  
}

/* ------------------------------ TABS ------------------------------ */

document.querySelectorAll(".tabs button").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
    document.querySelectorAll(".tab").forEach(s=>s.classList.add("hidden"));
    btn.classList.add("active");
    document.getElementById(btn.dataset.tab).classList.remove("hidden");
  });
});

/* ----------------------------- BOOT ------------------------------- */

document.getElementById("year").textContent = new Date().getFullYear();
loadData().catch(e=>{
  console.error(e);
  alert("Failed to load data. Check Firebase config and databaseURL in the config.");
});
</script>

</body>
</html>
